<?php

/**
 * InterfCommand - 上游接口方处理（仅用于临时操作）
 * @author luzhizhong
 * @version V1.0
 * 
 */

class InterfCommand extends CConsoleCommand
{
	/**
	 * 上游接口方的关联切换（格瓦拉切换到网票【指定影院】）
	 */
	public function actionInterfChange($args)
	{
		//GET到指定的影院+当前匹配的是格瓦拉+支持网票匹配
		$sql = "SELECT * FROM {{b_cinemaRelation}} WHERE iInterfaceID=10 AND iCinemaID IN(SELECT iCinemaID FROM {{b_cinemaRelation}} WHERE iInterfaceID=8) AND iCinemaID IN(2573,2088,6094,395,3985,2556,1346,1914,5380,2792,6064,3217,3338,2698,5015,2539,5584,214,1498,2305,2193,4572,547,6171,4786,5805,1719,4447,1902,4024,2371,2370,6822,3882,1992,436,3016,6276,2058,4622,2972,1184,2340,4734,1104,4728,2229,2438,4080,455,2117,1028,4030,1873,2388,2009,2030,5573,1915,566,2372,2814,1462,4955,1874,4028,2473,2073,1851,1852,2177,2047,4790,1591,1002,1034,2501,2199,1511,936,4575,2408,5709,2589,2100,4638,3889,6029,6725,4291,604,6490,2351,1649,1982,1653,3506,1031,3043,3046,5678,3029,1582,6041,1615,5215,5312,1428,1628,1178,3801,1833,4140,4991,1458,3517,3953,1730,4644,1770,1830,2841,5895,3245,1307,2096,5586,2491,1205,1862,1228,1669,5621,1088,4704,1698,2386,1964,2549,2045,447,2161,6813,5684,4978,2132,3999,6022,1617,984,2127,2225,957,236,374,6838,3108,2288,6387,2337,1778,2819,4125,1309,2979,1089,445,2373,5665,1025,1111,1452,2101,2278,2189,2669,4939,2317,3428,2141,6821,6697,1079,5701,435,2608,3100,1529,5079,3716,6110,5314,6368,1144,1116,1989,2089,6172,6689,4522,3121,2884,3735,4976,1086,6800,4740,5322,4802,2431,1276,1037,3568,2760,2025,1741,1430,2498,3829,4962,1603,4977,4123,6573,6549,5538,959,5894,2687,2242,3526,3550,5114,6295,2147,2775,3761,966,2798,4706,2591,2749,2746,2289,1063,1777,5567,2076,3819,5831,1666,4764,5090,3950,2886,6057,3713,5763,2107,5826,1201,5192,6487,4361,3242,1163,2246,6495,4648,2507,2731,1204,5604,5225,1822,5046,6241,5094,5987,2139,4753,1892,1505,2263,6207,2607,1781,2113,4510,5888,1577,938,2612,1651,2298,1507,1980,4469,2152,2207,4645,6466,2119,2094,4840,929,2106,247,952,1284,1334,3908,4836,5287,5543,6667,2518,1530,6557,5523,5566,345,2413,2793,3605,3616,3838,5898,3848,2115,4284,4190,1922,3572,1240,1780,6396,6610,6722,1604,200,1363,2801,3515,4008,4192,4278,5256,6173,6713,6618,5390,2338,3137,2458,1648,2577,3475,5033,5246,2028,2444,4452,2504,5472,224,269,4964,1592,4987,2359,1286,2966,6121,6209,6796,1673,271,3395,3056,2005,2986,3443,4475,5185,5908,6383,3888,5517,878,2114,5284,6320,4944,1467,3591,4861,2235,4433,5319,1805,4661,432,1316,3002,3264,939,3229,5495,6075,6447,3017,2729,2198,4329,2730,4626,4947,3538,318,463,551,2061,2414,2618,2619,2959,3013,3189,3193,3514,4721,6376,6688,6739,5223,5714,3597,2335,2360,2226,6239,3530,5560,4992,4988,708,3584,1422,2409,4952,5590,1068,1594,3076,3911,5383,5434,5659,5801,5870,6493,3613,584,273,6748,3918,3630,3034,2171,399,3507,360,414,754,944,1040,1570,1589,1663,1671,1945,2259,2432,2585,2653,2833,2852,2893,3048,3099,3214,3237,3238,3243,3260,3399,3580,3604,3726,3891,3905,4001,4114,4237,4863,4877,4925,4953,4981,5249,5304,5386,5413,5473,5509,5515,5572,5593,5790,5892,5922,5962,6062,6103,6106,6263,6479,6730,6738,965,948,6363,2365,4821,2629,2160,3842,4676,440,6580,5224,1762,1442,6107,1481,4701,3138,3482,6040,6367,3250,6464,466,5470,6831,2314,3612,6594,1167,5221,3095,5146,726,3546,305,5403,426,5518,473,799,1751,1923,1946,2205,2941,3235,3236,3295,5282,5540,5594,5990,6389,6735,2692,6511,1109,2029,3681,999,4919,5810,3414,4994,4954,3796,1349,244,970,2987,5004,5708,1717,1007,5357,2128,5530,971,4010,6086,3880,4185,4488,6240,2072,6169,5662,1887,3843,1419,3030,3611,3601,5234,5420,5040,261,2553,4573,6638,4605,1494,2630,2419,4610,2554,2136,3139,4631,1510,2638,3286,3326,4659,5430,6442,1421,1528,4345,5820,3476,4200,2014,1784,1864,3705,1484,2634,3036,5570,6517,6649,6709,3505,4148,1207,3855,6827,1272,1518,4086,3706,6406,872,1598,3442,4136,2752,3860,1343,6533,1409,556,2626,1733,3244,3728,3799,4940,5170,5278,5313,5412,5426,5435,5910,6421,6554,6724,6836,5829,1233,2817,1448,2846,5471,1473,3227,3808,2191,1293,2397,2975,5628,1812,1884,4442,4519,1125,3707,5598,1960,4153,4257,5202,6544,3204,1465,4388,1890,5135,3900,6747,1665,3956,4820,5080,5222,5938,4735,5728,262,6375,6741,3093,3489,6471,4298,6089,1991,5756,6184,6723,5601,1718,1994,5545,1294,2169,2686,3581,3881,3920,575,1745,1787,3192,3228,3233,3352,3592,3644,3864,3894,3967,4321,4353,4419,4698,4862,4873,5025,5070,5391,5395,5427,5740,5868,5901,6015,6111,6422,6744,6804,2770,4995,1342,1943,396,4273,5563,6077,1130,5109,3868,4846,6369,5147,6621,4990,3316,1115,1052,4594,5611,1774,4199,2992,5568,2316,3823,259,568,4258,5842,6148,2492,5722,274,934,3341,3702,3256,2750,232,6076,4583,4016,6626,2251,2732,5067,6090,1338,2733,3459,4319,5093,1418,1794,2320,3124,3353,4128,4133,4313,4331,4615,4662,4874,4965,5042,5047,5384,5650,5694,5786,6388,6415,6504,6563,5736,2380,3081,3158,1103,2900,2711,5775,2874,2999,6224,5082,324,2651,3704,4205,4440,4441,4591,1285,6503,992,4330,5030,5227,2914,320,3921,4416,5077,6690,231,2087,3207,2234,3865,1706,1869,2308,996,2534,4534,1783,1413,2826,3622,3942,4335,4614,4888,5294,5295,5749,5819,5824,5862,1557,6005,5330,6727,2284,4806,5220,5388,4092,5689,1354,4511,1017,2236,3342,599,3402,3621,5664,4527,2291,3471,4485,4973,5713,6425,1517,6201,6579,6083,5893,3522,1817,2533,2646,2688,3635,4402,5387,5539,1728,3200,3209,5854,6108,6264,1508,4532,5964,6625,6786,2399,6047,2809,1287,1337,3350,1901,2215,2780,2782,5153,3187,3620,985,6645,4948,1217,1711,3603,4415,5092,5603,5688,5948,6352,1304,3692,1271,991,2273,2797,3602,539,6718,6658,4336,4674,6226,2120,3426,2037,3132,4518,2829,3035,3552,6357,3867,5089,1722,495,503,505,569,580,623,1062,1082,1084,1105,1488,1489,1520,1911,2411,2427,2443,2460,2517,2658,2857,2862,3073,3241,3657,4283,5044,5841,6113,6158,6309,6382,6759,3075,3943,5214,6355,3890,1524,953,4966,1699,264,2962,3836,1797,5624,5767,6559,5863,2583,428,443,2483,2765,4937,3094,3906,3997,4799,2839,3608,6401,3239,4088,2213,2968,480,2424,2705,6122,4356,603,2751,3407,6035,1455,927,5906,1534,3307,3636,4221,4606,4903,1335,2593,2714,3656,3044,4327,2054,4685,6230,2145,4020,4149,1336,3191,6311,5085,1808,6758,2268,5483,1799,2482,2830,6845,2674,3673,3757,6665,516,4537,4612,869,913,3197,3946,6310,2470,3531,4023,5048,4632,4811,2596,550,482,1475,3131,3202,6620,5554,5712,2773,2784,3328,5638,406,1123,5778,5718,5974,6687,5785,1328,4180,4675,4817,5159,6306,1487,5218,5128,1766,2049,1250,4985,2017,1575,1578,2065,3133,6133,1013,5686,2013,3723,266) order by iCinemaID desc";
		$cinemaList = DbUtil::queryAll($sql);
		
		foreach($cinemaList as $key => $cinemaInfo)
		{
			$iCinemaID = $cinemaInfo['iCinemaID'];
			$sCinemaInterfaceID_WP = getCinemaInterfaceIDByRelation($iCinemaID, 8);
				
			if(empty($sCinemaInterfaceID_WP))
			{
				continue;
			}
			
			//修改tb_b_cinema表
			$sql = sprintf("UPDATE {{b_cinema}} SET sCinemaInterface='网票网(Wpiao)',iInterfaceID=8,sCinemaInterfaceNo='%s' WHERE iCinemaID=%d", $sCinemaInterfaceID_WP, $iCinemaID);
			DbUtil::execute($sql);
			
			//置换接口关联
			$sql = sprintf("UPDATE {{b_cinemaRelation}} SET sCinemaInterfaceNo='%s' WHERE iCinemaID=%d AND iInterfaceID=8", $sCinemaInterfaceID_WP, $iCinemaID);
			DbUtil::execute($sql);
			$sql = sprintf("UPDATE {{b_cinemaRelation}} SET sCinemaInterfaceNo='' WHERE iCinemaID=%d AND iInterfaceID=10", $iCinemaID);
			DbUtil::execute($sql);
			
			//删除影厅
			$sql = sprintf("DELETE FROM {{b_room}} WHERE iCinemaID=%d AND iInterfaceID=10", $iCinemaID);
			DbUtil::execute($sql);

			//清除排期
			$sql = sprintf("DELETE FROM {{e_roommovie}} WHERE iEpiaoCinemaID=%d AND iInterfaceID=10", $iCinemaID);
			DbUtil::execute($sql);
				
			echo $iCinemaID." / ".$sCinemaInterfaceID_WP. "\r\n";
		}
	
		echo "OK \r\n";
	}
}

/**
 * 获取接口方影院id（By 影院关联表【tb_b_cinemaRelation】）
 */
function getCinemaInterfaceIDByRelation($cinemaID, $interfaceID=8)
{
	$sql = sprintf("SELECT sCinemaInterfaceID FROM {{b_cinemaRelation}} WHERE iCinemaID=%d AND iInterfaceID=%d", $cinemaID, $interfaceID);
	$relationInfo = DbUtil::queryRow($sql);

	return empty($relationInfo) ? '' : $relationInfo['sCinemaInterfaceID'];
}
